<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Zombie City Survivor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            background: #1a1a1a;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #startMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #fff;
            z-index: 30;
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border-radius: 20px;
            border: 3px solid #ff0000;
        }
        
        #startMenu h1 {
            font-size: 48px;
            color: #ff0000;
            text-shadow: 0 0 20px #ff0000;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        #startMenu p {
            margin: 10px 0;
            font-size: 18px;
            color: #aaa;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10;
            display: none;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat {
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 5px;
            border: 2px solid #ff0000;
            font-size: 14px;
        }
        
        .coin-stat {
            background: rgba(255,215,0,0.2);
            border-color: #ffd700;
        }
        
        #vendorMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffd700;
            color: #fff;
            display: none;
            z-index: 25;
            pointer-events: all;
            max-width: 500px;
        }
        
        #vendorMenu h2 {
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .weapon-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .weapon-item:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .weapon-stats {
            font-size: 12px;
            color: #aaa;
        }
        
        button {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 1.2em;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(255,0,0,0.3);
        }
        
        button:hover {
            background: linear-gradient(135deg, #ff3333, #ff0000);
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(255,0,0,0.5);
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        .buy-button {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 5px 15px;
            font-size: 1em;
        }
        
        .buy-button:hover {
            background: linear-gradient(135deg, #ffed4e, #fff);
        }
        
        .buy-button:disabled {
            background: #666;
            color: #333;
            cursor: not-allowed;
            transform: none;
        }
        
        #gameOver, #levelUp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: #fff;
            display: none;
            z-index: 20;
            pointer-events: all;
            border: 2px solid #ff0000;
        }
        
        .upgrade-option {
            margin: 10px 0;
        }
        
        #vendorNotification {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            z-index: 15;
            animation: slideDown 0.5s;
            box-shadow: 0 5px 20px rgba(255,215,0,0.5);
        }
        
        @keyframes slideDown {
            from { top: -50px; opacity: 0; }
            to { top: 100px; opacity: 1; }
        }
        
        #currentWeapon {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #666;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Start Menu -->
    <div id="startMenu">
        <h1>üßü ZOMBIE CITY SURVIVOR üßü</h1>
        <p>Survive 15 minutes in the zombie apocalypse!</p>
        <p>üéÆ Use WASD or Arrow Keys to move</p>
        <p>üí∞ Collect coins to buy weapons from the vendor truck</p>
        <p>üî´ Switch weapons with number keys 1-9</p>
        <button onclick="startGame()">START GAME</button>
    </div>
    
    <!-- Game UI -->
    <div id="ui">
        <div class="stats">
            <div class="stat">‚ù§Ô∏è <span id="hp">100</span>/<span id="maxHp">100</span></div>
            <div class="stat coin-stat">üí∞ <span id="coins">0</span> Silver</div>
            <div class="stat">‚è∞ <span id="timer">15:00</span></div>
            <div class="stat">üíÄ <span id="kills">0</span></div>
            <div class="stat">‚≠ê Lv.<span id="level">1</span></div>
            <div class="stat">‚ú® <span id="xp">0</span>/<span id="xpNeeded">10</span></div>
        </div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
    
    <!-- Current Weapon Display -->
    <div id="currentWeapon" style="display:none;">
        <div>Current: <span id="weaponName">Pistol</span></div>
        <div style="font-size:12px; color:#aaa;">Ammo: <span id="weaponAmmo">‚àû</span></div>
    </div>
    
    <!-- Vendor Notification -->
    <div id="vendorNotification">
        üöö VENDOR TRUCK HAS ARRIVED! Press V to shop!
    </div>
    
    <!-- Vendor Menu -->
    <div id="vendorMenu">
        <h2>üöö WEAPON VENDOR</h2>
        <p style="text-align:center; color:#ffd700;">Your Coins: <span id="vendorCoins">0</span></p>
        <div id="weaponList"></div>
        <button onclick="closeVendor()">Close</button>
    </div>
    
    <!-- Level Up Menu -->
    <div id="levelUp">
        <h2>LEVEL UP!</h2>
        <p>Choose an upgrade:</p>
        <div id="upgradeOptions"></div>
    </div>
    
    <!-- Game Over -->
    <div id="gameOver">
        <h2 id="gameOverTitle">GAME OVER</h2>
        <p>You survived <span id="finalTime">0:00</span>!</p>
        <p>Total Kills: <span id="finalKills">0</span></p>
        <p>Coins Collected: <span id="finalCoins">0</span></p>
        <button onclick="resetGame()">Play Again</button>
    </div>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        // Canvas setup
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.imageSmoothingEnabled = false;
        });
        
        // Enhanced Sound System
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        function createSound(frequency, duration, type = 'square', volume = 0.1, modulation = null) {
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            // Apply modulation for more interesting sounds
            if (modulation) {
                const lfo = audioCtx.createOscillator();
                const lfoGain = audioCtx.createGain();
                lfo.frequency.value = modulation.rate;
                lfoGain.gain.value = modulation.depth;
                lfo.connect(lfoGain);
                lfoGain.connect(oscillator.frequency);
                lfo.start();
            }
            
            gainNode.gain.value = volume;
            oscillator.start();
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            oscillator.stop(audioCtx.currentTime + duration);
        }
        
        // Enhanced sound effects
        const sounds = {
            shoot: () => {
                // Layered gun sound
                createSound(150, 0.05, 'sawtooth', 0.08);
                createSound(600, 0.03, 'square', 0.05);
                setTimeout(() => createSound(100, 0.1, 'triangle', 0.03), 30);
            },
            shotgun: () => {
                // Big blast
                createSound(80, 0.15, 'sawtooth', 0.12);
                createSound(200, 0.08, 'square', 0.08);
                createSound(50, 0.2, 'sine', 0.1);
            },
            machinegun: () => {
                // Rapid fire
                createSound(250, 0.03, 'square', 0.04);
                createSound(120, 0.05, 'sawtooth', 0.03);
            },
            sniper: () => {
                // Powerful shot
                createSound(60, 0.3, 'sine', 0.1);
                createSound(800, 0.05, 'sawtooth', 0.08);
                setTimeout(() => createSound(40, 0.4, 'sine', 0.05), 50);
            },
            hit: () => {
                // Impact sound
                createSound(120, 0.08, 'sawtooth', 0.06);
                createSound(200, 0.05, 'square', 0.04, {rate: 20, depth: 50});
            },
            coin: () => {
                // Coin pickup melody
                createSound(800, 0.1, 'sine', 0.08);
                setTimeout(() => createSound(1000, 0.1, 'sine', 0.06), 50);
                setTimeout(() => createSound(1200, 0.15, 'sine', 0.05), 100);
            },
            levelUp: () => {
                // Victory fanfare
                createSound(400, 0.2, 'triangle', 0.1);
                setTimeout(() => createSound(500, 0.2, 'triangle', 0.08), 100);
                setTimeout(() => createSound(600, 0.2, 'triangle', 0.08), 200);
                setTimeout(() => createSound(800, 0.3, 'sine', 0.1), 300);
            },
            vendorArrive: () => {
                // Truck horn
                createSound(200, 0.3, 'sawtooth', 0.1);
                setTimeout(() => createSound(250, 0.3, 'sawtooth', 0.1), 200);
            },
            zombieDeath: () => {
                // Splat
                createSound(60, 0.15, 'sawtooth', 0.06, {rate: 30, depth: 20});
                createSound(100, 0.1, 'square', 0.04);
            },
            playerHit: () => {
                // Pain sound
                createSound(50, 0.2, 'sawtooth', 0.12);
                createSound(100, 0.15, 'square', 0.08, {rate: 10, depth: 30});
            },
            meleeSwing: () => {
                // Swoosh
                createSound(200, 0.1, 'sine', 0.06);
                createSound(150, 0.15, 'triangle', 0.05, {rate: 50, depth: 100});
            }
        };
        
        // Constants
        const TILE_SIZE = 32;
        const MAP_WIDTH = 80;
        const MAP_HEIGHT = 80;
        const GAME_TIME = 15 * 60 * 1000;
        
        // Weapon definitions
        const WEAPONS = {
            pistol: {
                name: 'Pistol',
                type: 'ranged',
                damage: 10,
                fireRate: 500,
                range: 300,
                bulletSpeed: 8,
                bulletSize: 4,
                piercing: 1,
                multishot: 1,
                price: 0,
                sound: 'shoot'
            },
            shotgun: {
                name: 'Shotgun',
                type: 'ranged',
                damage: 8,
                fireRate: 800,
                range: 200,
                bulletSpeed: 10,
                bulletSize: 3,
                piercing: 1,
                multishot: 5,
                spread: 0.3,
                price: 50,
                sound: 'shotgun'
            },
            machinegun: {
                name: 'Machine Gun',
                type: 'ranged',
                damage: 15,
                fireRate: 100,
                range: 350,
                bulletSpeed: 12,
                bulletSize: 3,
                piercing: 2,
                multishot: 1,
                price: 100,
                sound: 'machinegun'
            },
            sniper: {
                name: 'Sniper Rifle',
                type: 'ranged',
                damage: 100,
                fireRate: 1500,
                range: 600,
                bulletSpeed: 20,
                bulletSize: 6,
                piercing: 5,
                multishot: 1,
                price: 150,
                sound: 'sniper'
            },
            sword: {
                name: 'Sword',
                type: 'melee',
                damage: 30,
                fireRate: 400,
                range: 60,
                arc: Math.PI/3,
                price: 75
            },
            axe: {
                name: 'Battle Axe',
                type: 'melee',
                damage: 50,
                fireRate: 700,
                range: 70,
                arc: Math.PI/4,
                price: 120
            },
            bat: {
                name: 'Baseball Bat',
                type: 'melee',
                damage: 20,
                fireRate: 300,
                range: 50,
                arc: Math.PI/2,
                knockback: 40,
                price: 40
            },
            katana: {
                name: 'Katana',
                type: 'melee',
                damage: 40,
                fireRate: 350,
                range: 80,
                arc: Math.PI/3,
                price: 200
            }
        };
        
        // Game state
        const game = {
            started: false,
            startTime: 0,
            coins: 0,
            kills: 0,
            level: 1,
            xp: 0,
            xpNeeded: 10,
            paused: false,
            cameraX: 0,
            cameraY: 0,
            shake: 0,
            vendorActive: false,
            vendorX: 0,
            vendorY: 0,
            lastVendorSpawn: 0,
            vendorDuration: 30000,
            vendorInterval: 60000,
            currentWeapon: 'pistol'
        };
        
        // Player
        const player = {
            x: MAP_WIDTH * TILE_SIZE / 2,
            y: MAP_HEIGHT * TILE_SIZE / 2,
            width: 24,
            height: 24,
            speed: 3,
            hp: 100,
            maxHp: 100,
            lastShot: 0,
            hitFlash: 0,
            alive: true,
            facing: 'right',
            meleeAngle: 0,
            meleeActive: false,
            inventory: ['pistol']
        };
        
        // Get current weapon
        function getCurrentWeapon() {
            return WEAPONS[game.currentWeapon];
        }
        
        // Arrays
        let zombies = [];
        let bullets = [];
        let particles = [];
        let items = [];
        let obstacles = [];
        let roads = [];
        let decorations = [];
        
        // Input
        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key.toLowerCase()] = true;
            
            if (e.key.toLowerCase() === 'v' && game.vendorActive) {
                openVendor();
            }
            
            const num = parseInt(e.key);
            if (num >= 1 && num <= 9 && player.inventory[num - 1]) {
                game.currentWeapon = player.inventory[num - 1];
                updateWeaponDisplay();
            }
        });
        
        window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
        
        // Enhanced city generation
        function generateCity() {
            obstacles = [];
            roads = [];
            decorations = [];
            
            // Create main roads in a grid pattern
            const roadWidth = 4;
            
            // Main horizontal roads
            for (let i = 1; i < 4; i++) {
                roads.push({
                    x: 0,
                    y: (i * MAP_HEIGHT / 4 - roadWidth/2) * TILE_SIZE,
                    width: MAP_WIDTH * TILE_SIZE,
                    height: roadWidth * TILE_SIZE,
                    type: 'horizontal'
                });
            }
            
            // Main vertical roads
            for (let i = 1; i < 4; i++) {
                roads.push({
                    x: (i * MAP_WIDTH / 4 - roadWidth/2) * TILE_SIZE,
                    y: 0,
                    width: roadWidth * TILE_SIZE,
                    height: MAP_HEIGHT * TILE_SIZE,
                    type: 'vertical'
                });
            }
            
            // Generate city blocks between roads
            for (let blockX = 0; blockX < 4; blockX++) {
                for (let blockY = 0; blockY < 4; blockY++) {
                    const startX = blockX * MAP_WIDTH / 4 * TILE_SIZE;
                    const startY = blockY * MAP_HEIGHT / 4 * TILE_SIZE;
                    const blockWidth = MAP_WIDTH / 4 * TILE_SIZE;
                    const blockHeight = MAP_HEIGHT / 4 * TILE_SIZE;
                    
                    // Add 1-2 buildings per block
                    const numBuildings = 1 + Math.floor(Math.random() * 2);
                    for (let b = 0; b < numBuildings; b++) {
                        const building = {
                            x: startX + TILE_SIZE * 2 + Math.random() * (blockWidth - TILE_SIZE * 8),
                            y: startY + TILE_SIZE * 2 + Math.random() * (blockHeight - TILE_SIZE * 8),
                            width: TILE_SIZE * (3 + Math.floor(Math.random() * 3)),
                            height: TILE_SIZE * (3 + Math.floor(Math.random() * 3)),
                            color: `rgb(${30 + Math.random() * 40}, ${30 + Math.random() * 40}, ${30 + Math.random() * 40})`
                        };
                        
                        // Check if building overlaps with roads
                        let valid = true;
                        for (const road of roads) {
                            if (!(building.x + building.width < road.x || building.x > road.x + road.width ||
                                  building.y + building.height < road.y || building.y > road.y + road.height)) {
                                valid = false;
                                break;
                            }
                        }
                        
                        if (valid) {
                            obstacles.push(building);
                            
                            // Add dumpster near building
                            if (Math.random() < 0.5) {
                                decorations.push({
                                    type: 'dumpster',
                                    x: building.x + building.width + 5,
                                    y: building.y + Math.random() * (building.height - 20),
                                    width: 20,
                                    height: 16
                                });
                            }
                        }
                    }
                }
            }
            
            // Add street lights along roads
            roads.forEach(road => {
                const numLights = 5;
                for (let i = 0; i < numLights; i++) {
                    if (road.type === 'horizontal') {
                        decorations.push({
                            type: 'streetlight',
                            x: (i + 1) * road.width / (numLights + 1),
                            y: road.y - 10,
                            on: true
                        });
                    } else {
                        decorations.push({
                            type: 'streetlight',
                            x: road.x - 10,
                            y: (i + 1) * road.height / (numLights + 1),
                            on: true
                        });
                    }
                }
            });
            
            // Add traffic lights at intersections
            for (let i = 1; i < 4; i++) {
                for (let j = 1; j < 4; j++) {
                    decorations.push({
                        type: 'trafficlight',
                        x: i * MAP_WIDTH / 4 * TILE_SIZE - 20,
                        y: j * MAP_HEIGHT / 4 * TILE_SIZE - 20,
                        state: Math.floor(Math.random() * 3)
                    });
                }
            }
            
            // Add parked cars
            for (let i = 0; i < 20; i++) {
                const road = roads[Math.floor(Math.random() * roads.length)];
                const car = {
                    type: 'car',
                    width: 40,
                    height: 24,
                    color: `hsl(${Math.random() * 360}, 50%, ${30 + Math.random() * 20}%)`,
                    damaged: Math.random() < 0.3
                };
                
                if (road.type === 'horizontal') {
                    car.x = Math.random() * (road.width - car.width);
                    car.y = road.y + (Math.random() < 0.5 ? 10 : road.height - car.height - 10);
                    car.rotation = Math.random() < 0.5 ? 0 : Math.PI;
                } else {
                    car.x = road.x + (Math.random() < 0.5 ? 10 : road.width - car.width - 10);
                    car.y = Math.random() * (road.height - car.height);
                    car.rotation = Math.random() < 0.5 ? Math.PI/2 : -Math.PI/2;
                }
                
                decorations.push(car);
            }
            
            // Add trash cans
            for (let i = 0; i < 30; i++) {
                decorations.push({
                    type: 'trashcan',
                    x: Math.random() * MAP_WIDTH * TILE_SIZE,
                    y: Math.random() * MAP_HEIGHT * TILE_SIZE,
                    tipped: Math.random() < 0.2
                });
            }
            
            // Add containers/barriers
            for (let i = 0; i < 10; i++) {
                decorations.push({
                    type: 'container',
                    x: Math.random() * MAP_WIDTH * TILE_SIZE,
                    y: Math.random() * MAP_HEIGHT * TILE_SIZE,
                    width: 60,
                    height: 30,
                    color: Math.random() < 0.5 ? '#aa4444' : '#4444aa'
                });
            }
        }
        
        // Collision detection
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }
        
        function checkObstacleCollision(entity) {
            for (const obs of obstacles) {
                if (checkCollision(entity, obs)) {
                    return obs;
                }
            }
            return null;
        }
        
        // Enhanced Zombie AI
        class Zombie {
            constructor(elite = false) {
                this.elite = elite;
                
                // Spawn from edge
                const side = Math.floor(Math.random() * 4);
                const margin = 100;
                
                switch(side) {
                    case 0:
                        this.x = game.cameraX + Math.random() * canvas.width;
                        this.y = game.cameraY - margin;
                        break;
                    case 1:
                        this.x = game.cameraX + canvas.width + margin;
                        this.y = game.cameraY + Math.random() * canvas.height;
                        break;
                    case 2:
                        this.x = game.cameraX + Math.random() * canvas.width;
                        this.y = game.cameraY + canvas.height + margin;
                        break;
                    case 3:
                        this.x = game.cameraX - margin;
                        this.y = game.cameraY + Math.random() * canvas.height;
                        break;
                }
                
                this.width = 20;
                this.height = 20;
                
                if (elite) {
                    this.speed = 0.8;
                    this.hp = 100;
                    this.maxHp = 100;
                    this.damage = 20;
                    this.coinChance = 0.5;
                    this.coinAmount = 3;
                    this.color = '#8855aa';
                } else {
                    this.speed = 0.5 + Math.random() * 0.5;
                    this.hp = 30;
                    this.maxHp = 30;
                    this.damage = 10;
                    this.coinChance = 0.3;
                    this.coinAmount = 1;
                    this.color = '#669966';
                }
                
                this.stunTimer = 0;
                this.stuckTimer = 0;
                this.lastX = this.x;
                this.lastY = this.y;
                this.avoidAngle = 0;
            }
            
            update() {
                if (this.stunTimer > 0) {
                    this.stunTimer--;
                    return false;
                }
                
                // Check if stuck
                const moveDistance = Math.abs(this.x - this.lastX) + Math.abs(this.y - this.lastY);
                if (moveDistance < 0.1) {
                    this.stuckTimer++;
                    if (this.stuckTimer > 30) {
                        // Try to move in a different direction
                        this.avoidAngle = Math.random() * Math.PI * 2;
                        this.stuckTimer = 0;
                    }
                } else {
                    this.stuckTimer = 0;
                    this.avoidAngle *= 0.9; // Gradually return to normal pathing
                }